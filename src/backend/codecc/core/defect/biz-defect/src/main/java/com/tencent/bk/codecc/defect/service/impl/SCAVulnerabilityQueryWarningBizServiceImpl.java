package com.tencent.bk.codecc.defect.service.impl;

import com.google.common.collect.Lists;
import com.google.common.collect.Sets;
import com.tencent.bk.codecc.defect.dao.SCAQueryWarningParams;
import com.tencent.bk.codecc.defect.dao.defect.mongorepository.sca.BuildSCAVulnerabilityRepository;
import com.tencent.bk.codecc.defect.dao.defect.mongorepository.sca.SCAVulnerabilityRepository;
import com.tencent.bk.codecc.defect.dao.defect.mongotemplate.SCAVulnerabilityDao;
import com.tencent.bk.codecc.defect.model.sca.BuildSCAVulnerabilityEntity;
import com.tencent.bk.codecc.defect.model.sca.SCAVulnerabilityEntity;
import com.tencent.bk.codecc.defect.resources.ServiceTaskLogOverviewResourceImpl;
import com.tencent.bk.codecc.defect.service.ISCAQueryWarningService;
import com.tencent.bk.codecc.defect.service.TaskLogService;
import com.tencent.bk.codecc.defect.service.impl.sca.SCAClusterDefectServiceImpl;
import com.tencent.bk.codecc.defect.utils.ParamUtils;
import com.tencent.bk.codecc.defect.utils.SCAUtils;
import com.tencent.bk.codecc.defect.vo.common.QueryWarningPageInitRspVO;
import com.tencent.bk.codecc.defect.vo.sca.SCADefectDetailQueryReqVO;
import com.tencent.bk.codecc.defect.vo.sca.SCADefectGroupStatisticVO;
import com.tencent.bk.codecc.defect.vo.sca.SCADefectQueryReqVO;
import com.tencent.bk.codecc.defect.vo.sca.SCAQueryWarningPageInitRspVO;
import com.tencent.bk.codecc.defect.vo.sca.SCAVulnerabilityDefectDetailQueryRspVO;
import com.tencent.bk.codecc.defect.vo.sca.SCAVulnerabilityDefectQueryRspVO;
import com.tencent.bk.codecc.defect.vo.sca.SCAVulnerabilityVO;
import com.tencent.bk.codecc.defect.vo.sca.SCAVulnerabilityDetailVO;
import com.tencent.devops.common.api.pojo.Page;
import com.tencent.devops.common.codecc.util.JsonUtil;
import com.tencent.devops.common.constant.ComConstants;
import com.tencent.devops.common.util.BeanUtils;
import com.tencent.devops.common.util.GsonUtils;
import java.util.ArrayList;
import java.util.HashMap;
import java.util.HashSet;
import java.util.List;
import java.util.Map;
import java.util.Set;
import lombok.extern.slf4j.Slf4j;
import org.apache.commons.collections.CollectionUtils;
import org.apache.commons.lang.StringUtils;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.data.domain.Sort;
import org.springframework.stereotype.Service;

import java.util.stream.Collectors;

@Slf4j
@Service("SCAVulnerabilityQueryWarningBizService")
public class SCAVulnerabilityQueryWarningBizServiceImpl implements ISCAQueryWarningService {
    @Autowired
    private SCAVulnerabilityDao scaVulnerabilityDao;
    @Autowired
    private BuildSCAVulnerabilityRepository buildSCAVulnerabilityRepository;
    @Autowired
    private SCAVulnerabilityRepository scaVulnerabilityRepository;
    @Autowired
    private SCAClusterDefectServiceImpl scaClusterDefectServiceImpl;
    @Autowired
    private ServiceTaskLogOverviewResourceImpl serviceTaskLogOverviewResourceImpl;
    @Autowired
    protected TaskLogService taskLogService;

    /**
     * 处理SCA漏洞列表查询
     * @param scaQueryWarningParams
     * @param pageNum
     * @param pageSize
     * @param sortField
     * @param sortType
     * @return
     */
    @Override
    public SCAVulnerabilityDefectQueryRspVO processQueryWarningRequest(
            SCAQueryWarningParams scaQueryWarningParams,
            int pageNum,
            int pageSize,
            String sortField,
            Sort.Direction sortType
    ) {
        SCAVulnerabilityDefectQueryRspVO scaVulnerabilityDefectQueryRspVO =
                new SCAVulnerabilityDefectQueryRspVO();
        scaVulnerabilityDefectQueryRspVO.setVulnerabilityList(
                new Page<>(0, pageNum, pageSize, 0, Lists.newArrayList()));

        SCADefectQueryReqVO request = scaQueryWarningParams.getScaDefectQueryReqVO();

        // 处理快照请求参数buildId: 筛选出执行成功的快照的告警id列表
        Map<Long, List<String>> taskToolMap = scaQueryWarningParams.getTaskToolMap();
        Map.Entry<Long, List<String>> firstEntry = taskToolMap.entrySet().iterator().next();

        Long taskId = firstEntry.getKey();
        List<String> toolNameList = firstEntry.getValue();
        String buildId = request.getBuildId();
        List<String> scaDimensionList = request.getScaDimensionList();

        Set<String> defectMongoIdSet = StringUtils.isNotBlank(buildId)
                ? SCAUtils.getVulnerabilityEntityIdsByBuildId(taskId, toolNameList, buildId, scaDimensionList)
                : Sets.newHashSet();

        scaQueryWarningParams.setScaDefectMongoIdSet(defectMongoIdSet);

        // 更新请求中的状态筛选条件
        Set<String> statusProcessed = ParamUtils.getStatusProcessed(request.getStatus());
        request.setStatus(statusProcessed);

        // 查询告警
        Page<SCAVulnerabilityEntity> result = scaVulnerabilityDao.findVulnerabilityPageByCondition(
                scaQueryWarningParams,
                pageNum,
                pageSize,
                sortField,
                sortType
        );

        log.info("SCA vul list query defectMongoIdSet size:{}, result records size:{},taskId {}, buildId {}",
                defectMongoIdSet.size(),
                JsonUtil.INSTANCE.toJson(result.getRecords().size()),
                request.getTaskIdList(),
                buildId
        );

        List<SCAVulnerabilityVO> vulnerabilityVOList;
        Map<Integer, Integer> severityCountMap = new HashMap<>();
        Map<Integer, Integer> statusCountMap = new HashMap<>();
        List<SCAVulnerabilityEntity> records = result.getRecords();
        if (CollectionUtils.isNotEmpty(records)) {
            vulnerabilityVOList = records.stream().map(scaVulnerabilityEntity -> {
                SCAVulnerabilityVO scaVulnerabilityVO = new SCAVulnerabilityVO();
                BeanUtils.copyProperties(scaVulnerabilityEntity, scaVulnerabilityVO);
                int severity = scaVulnerabilityVO.getSeverity() == ComConstants.PROMPT_IN_DB
                        ? ComConstants.PROMPT
                        : scaVulnerabilityVO.getSeverity();
                scaVulnerabilityVO.setSeverity(severity);

                // 更新计数
                severityCountMap.put(severity, severityCountMap.getOrDefault(severity, 0) + 1);
                int status = scaVulnerabilityVO.getStatus();
                statusCountMap.put(status, statusCountMap.getOrDefault(status, 0) + 1);
                return scaVulnerabilityVO;
            }).collect(Collectors.toList());

            Page<SCAVulnerabilityVO> pageResult = new Page<>(result.getCount(), result.getPage(),
                    result.getPageSize(), result.getTotalPages(), vulnerabilityVOList);
            scaVulnerabilityDefectQueryRspVO.setVulnerabilityList(pageResult);
        }

        // 统计结果
        scaVulnerabilityDefectQueryRspVO.setLowCount(severityCountMap.getOrDefault(ComConstants.PROMPT, 0));
        scaVulnerabilityDefectQueryRspVO.setMediumCount(severityCountMap.getOrDefault(ComConstants.NORMAL, 0));
        scaVulnerabilityDefectQueryRspVO.setHighCount(severityCountMap.getOrDefault(ComConstants.SERIOUS, 0));
        scaVulnerabilityDefectQueryRspVO.setTotalCount(Integer.parseInt(String.valueOf(result.getCount())));

        int pathMaskCount = statusCountMap.getOrDefault(ComConstants.DefectStatus.PATH_MASK.value(), 0);
        int checkerMaskCount = statusCountMap.getOrDefault(ComConstants.DefectStatus.CHECKER_MASK.value(), 0);
        scaVulnerabilityDefectQueryRspVO.setExistCount(
                statusCountMap.getOrDefault(ComConstants.DefectStatus.NEW.value(), 0));
        scaVulnerabilityDefectQueryRspVO.setFixCount(
                statusCountMap.getOrDefault(ComConstants.DefectStatus.FIXED.value(), 0));
        scaVulnerabilityDefectQueryRspVO.setIgnoreCount(
                statusCountMap.getOrDefault(ComConstants.DefectStatus.IGNORE.value(), 0));
        scaVulnerabilityDefectQueryRspVO.setMaskCount(
                pathMaskCount + checkerMaskCount);

        return scaVulnerabilityDefectQueryRspVO;
    }

    /**
     * 处理漏洞详情查询
     * @param requestVO
     * @return
     */
    @Override
    public SCAVulnerabilityDefectDetailQueryRspVO processQueryWarningDetailRequest(
            SCADefectDetailQueryReqVO requestVO
    ) {
        SCAVulnerabilityDefectDetailQueryRspVO responseVO = new SCAVulnerabilityDefectDetailQueryRspVO();
        SCAVulnerabilityDetailVO vulnerabilityDetailVO = new SCAVulnerabilityDetailVO();

        SCAVulnerabilityEntity entity = scaVulnerabilityRepository.findByEntityId(requestVO.getEntityId());
        if (entity == null) {
            log.info("vulnerability not found by entity id {}", requestVO.getEntityId());
            return responseVO;
        }
        BeanUtils.copyProperties(entity, vulnerabilityDetailVO);
        responseVO.setScaVulnerabilityDetailVO(vulnerabilityDetailVO);

        return responseVO;
    }

    @Override
    public Object pageInit(SCAQueryWarningParams scaQueryWarningParams) {
        SCAQueryWarningPageInitRspVO response = new SCAQueryWarningPageInitRspVO();
        SCADefectQueryReqVO request = scaQueryWarningParams.getScaDefectQueryReqVO();
        // 跨任务查询时，不执行聚合统计
        if (Boolean.TRUE.equals(request.getMultiTaskQuery())) {
            return response;
        }
        String buildId = request.getBuildId();

        // 处理严重程度、告警类型条件：置null，因为需要统计所有风险等级和告警类型的数量
        request.setSeverity(null);
        request.setDefectType(null);

        // 处理快照查询条件：获取执行成功的快照的告警列表defectMongoIdSet
        Map<Long, List<String>> taskToolMap = scaQueryWarningParams.getTaskToolMap();
        Map.Entry<Long, List<String>> firstEntry = taskToolMap.entrySet().iterator().next();

        Long taskId = firstEntry.getKey();
        List<String> toolNameList = firstEntry.getValue();
        List<String> scaDimensionList = request.getScaDimensionList();

        Set<String> defectMongoIdSet = StringUtils.isNotBlank(buildId)
                ? SCAUtils.getVulnerabilityEntityIdsByBuildId(taskId, toolNameList, buildId, scaDimensionList)
                : Sets.newHashSet();
        scaQueryWarningParams.setScaDefectMongoIdSet(defectMongoIdSet);

        // 处理状态查询条件：默认添加查询待修复的告警
        Set<String> condStatusList = request.getStatus();
        if (CollectionUtils.isEmpty(condStatusList)) {
            condStatusList = new HashSet<>(1);
            condStatusList.add(String.valueOf(ComConstants.DefectStatus.NEW.value()));
            request.setStatus(condStatusList);
        }

        // 将处理后的条件通过scaDefectListQueryParams参数类进行传递
        scaQueryWarningParams.setScaDefectQueryReqVO(request);

        // 获取统计类型
        String statisticType = request.getStatisticType();

        if (ComConstants.StatisticType.STATUS.name().equalsIgnoreCase(statisticType)) {
            // 1.根据快照、依赖方式、处理人、日期、语言、组件名称过滤后，计算各状态告警数
            statisticByStatus(scaQueryWarningParams, response);
        } else if (ComConstants.StatisticType.SEVERITY.name().equalsIgnoreCase(statisticType)) {
            // 2.根据快照、依赖方式、处理人、日期、语言、组件名称过滤后， 各严重级别告警数
            statisticBySeverity(scaQueryWarningParams, response);
        } else {
            log.error("StatisticType is invalid. {}", GsonUtils.toJson(request));
        }

        return response;
    }

    @Override
    public QueryWarningPageInitRspVO processQueryAuthorsRequest(
            SCAQueryWarningParams scaQueryWarningParams
    ) {
        SCADefectQueryReqVO request = scaQueryWarningParams.getScaDefectQueryReqVO();
        Map<Long, List<String>> taskToolMap = scaQueryWarningParams.getTaskToolMap();

        // 1.处理Package快照查询条件，获取快照告警id列表
        String buildId = request.getBuildId();
        if (StringUtils.isNotBlank(buildId)) {
            Map.Entry<Long, List<String>> firstEntry = taskToolMap.entrySet().iterator().next();
            Set<String> defectMongoIdSet = SCAUtils.getVulnerabilityEntityIdsByBuildId(
                    firstEntry.getKey(),
                    firstEntry.getValue(),
                    buildId,
                    request.getScaDimensionList()
            );
            scaQueryWarningParams.setScaDefectMongoIdSet(defectMongoIdSet);
        }

        // 2.执行聚合查询获取作者列表
        List<String> authors = scaVulnerabilityDao.findAuthorsByCondition(
                scaQueryWarningParams
        );

        // 3.构建返回结果
        QueryWarningPageInitRspVO response = new QueryWarningPageInitRspVO();
        response.setAuthorList(authors);
        return response;
    }

    /**
     * 统计添加筛选条件后的各状态告警数量
     * @param scaQueryWarningParams
     * @param response
     */
    private void statisticByStatus(
            SCAQueryWarningParams scaQueryWarningParams,
            SCAQueryWarningPageInitRspVO response
    ) {
        SCADefectQueryReqVO request = scaQueryWarningParams.getScaDefectQueryReqVO();
        Set<String> originalStatus = request.getStatus();
        List<SCADefectGroupStatisticVO> groups =
                scaVulnerabilityDao.statisticByStatus(scaQueryWarningParams);

        groups.forEach(it -> {
            int status = it.getStatus();

            if (ComConstants.DefectStatus.NEW.value() == status) {
                response.setExistCount(response.getExistCount() + it.getDefectCount());
            } else if ((ComConstants.DefectStatus.FIXED.value() & status) > 0) {
                response.setFixCount(response.getFixCount() + it.getDefectCount());
            } else if ((ComConstants.DefectStatus.IGNORE.value() & status) > 0) {
                response.setIgnoreCount(response.getIgnoreCount() + it.getDefectCount());
            } else if ((ComConstants.DefectStatus.PATH_MASK.value() & status) > 0
                    || (ComConstants.DefectStatus.CHECKER_MASK.value() & status) > 0) {
                response.setMaskCount(response.getMaskCount() + it.getDefectCount());
            }
        });

        // 若是快照查，则修正统计；快照查已移除"已修复"状态
        if (StringUtils.isNotEmpty(request.getBuildId())) {
            // 已忽略、已屏蔽在多分支下是共享的；而待修复与已修复是互斥的
            response.setExistCount(response.getExistCount() + response.getFixCount());
            response.setFixCount(0);
        }
        request.setStatus(originalStatus);
    }

    /**
     * 统计添加筛选条件后的各风险等级告警数量
     * @param scaQueryWarningParams
     * @param response
     */
    private void statisticBySeverity(
            SCAQueryWarningParams scaQueryWarningParams,
            SCAQueryWarningPageInitRspVO response
    ) {
        List<SCADefectGroupStatisticVO> groups =
                scaVulnerabilityDao.statisticBySeverity(scaQueryWarningParams);

        groups.forEach(it -> {
            if (ComConstants.SERIOUS == it.getSeverity()) {
                response.setSeriousCount(response.getSeriousCount() + it.getDefectCount());
            } else if (ComConstants.NORMAL == it.getSeverity()) {
                response.setNormalCount(response.getNormalCount() + it.getDefectCount());
            } else if (ComConstants.PROMPT_IN_DB == it.getSeverity() || ComConstants.PROMPT == it.getSeverity()) {
                response.setPromptCount(response.getPromptCount() + it.getDefectCount());
            }
        });
    }
}
